import "pe"

rule nefilim_ransomware {

   meta:

      description = "Rule to detect Nefilim ransomware"
      author = "Marc Rivero | McAfee ATR Team"
      reference = "https://www.bleepingcomputer.com/news/security/new-nefilim-ransomware-threatens-to-release-victims-data/"
      date = "2020-03-17"
      last_update = "2020-04-03"
      hash = "5ab834f599c6ad35fcd0a168d93c52c399c6de7d1c20f33e25cb1fdb25aec9c6"

   strings:

      $s1 = "C:\\Users\\Administrator\\Desktop\\New folder\\Release\\NEFILIM.pdb" fullword ascii
      $s2 = "oh how i did it??? bypass sofos hah" fullword ascii
      $s3 = " /c timeout /t 3 /nobreak && del \"" fullword wide
      $s4 = "NEFILIM-DECRYPT.txt" fullword wide

      $op0 = { db ff ff ff 55 8b ec 83 ec 24 53 56 57 89 55 f4 }
      $op1 = { 60 be 00 d0 40 00 8d be 00 40 ff ff 57 eb 0b 90 }
      $op2 = { 84 e0 40 00 90 d1 40 00 08 }

      /*

      BYTES:

      558BEC83EC245356578955F4294DF46A048D72038D79015A8BC78955DC8A5EFD8858FF8B5DF48A1C0388188A5EFF8858018A1E88580203F203C2FF4DDC75DE8955F48D51038D42108D59028945F8894DF0297DF0895DEC297DEC8955E8297DE88D470C8D7902894DE4297DE48955DC297DDC8B7DF8894DE02955E08D7102F645F4038B5DEC8A1C038B4DF08A14018A08885DFA8B5DE88A1C03885DFB753B0FB6DB8A9B803040000FB6C98855FF8A91803040000FB64DFA8A8980304000885DFA0FB65DFF8A9B80304000885DFB8B5DF4C1EB023293803240008B5DE48A1C3332DA8B55E0881C178A50F432D18850048A0E324DFA83C004884E108B4DDC8A0C31324DFBFF45F4880F83C60483C704837DF42C0F8266FFFFFF5F5E5BC9C3558BEC560FB6C057C1E0040345086A045F6A045E8A10301140414E75F74F75F15F5E5DC356576A045F6A048BC15E0FB6108A9280304000881083C0044E75EF414F75E65F5EC38A50058A48018850018A50098850058A500D8850098A500A88480D8A48028850028A500E88480A8A48068850068A500F88480E8A48038850038A500B88500F8A500788500B884807C3558BEC5153566A0483C1025E8A410132018A51FE8A59FF8845FD32C232C38845FF8855FE32D38AC2C0E807B31BF6EB02D232C23245FE8A51FF3245FF32118841FE8AC2C0E807F6EB02D232C23241FF8A55FD3245FF8841FF8AC2C0E807F6EB02D232C232018A51013245FF3255FE88018AC2C0E807F6EB02D232C232410183C1043245FF4E8841FD75825E5BC9C3558BEC53FF75088BCE32C0E8D3FEFFFF59B3018BCEE8EDFEFFFF8BC6E808FFFFFF8BCEE84AFFFFFFFF75088BCE8AC3E8AFFEFFFFFEC35980FB0A72D78BCEE8C4FEFFFF8BC6E8DFFEFFFF5B8BCEB00A5DE98EFEFFFF558BEC81ECC000000053568D8D40FFFFFFE85BFDFFFF33DB6A1059395D0C764D5783F91075358B75108D7DF0A5A5A58D8540FFFFFFA5508D75F0E86CFFFFFF596A0F588B4D108D1408803AFF750848C6020079EFEB03FE040833C98A540DF08B450830141843413B5D0C72B55F8B45148B4D106A102BC85E8A14018810404E75F75E5BC9C3558BEC81EC1C02000053FF75088D85E4FDFFFF50FF155C304000688C3240008D85E4FDFFFF50FF155030400033DB53536A02535368000000408D85E4FDFFFF50FF15343040008945F03BC30F849600000056578D45FC5053BE6038400056895DFCFF15083040005056E8C809000083C41085C0750753FF1500304000FF75FC8B3D2430400053FFD750FF15103040008D4DFC5150568945F8FF15083040005056E89109000083C41085C074C98B45FC8945F48D45F450FF75F8E8C909000059595385C074B18D45EC50FF75FCFF75F8FF75F0FF1528304000FF75F853FFD750FF15183040005F5E5BC9C3558BEC83E4F881EC64060000535657FF75088D84246C04000050FF155C3040008B1D5030400068B83240008D84246C04000050FFD38D442410508D84246C04000050FF15043040008944240C83F8FF0F84580300008B354C30400068C03240008D44244050FFD685C00F841D03000068C43240008D44244050FFD685C00F840903000068CC3240008D44244050FFD685C00F84F502000068D43240008D44244050FFD685C00F84E102000068E43240008D44244050FFD685C00F84CD02000068003340008D44244050FFD685C00F84B902000068083340008D44244050FFD685C00F84A502000068103340008D44244050FFD685C00F8491020000682C3340008D44244050FFD685C00F847D02000068383340008D44244050FFD685C00F8469020000684C3340008D44244050FFD685C00F8455020000685C3340008D44244050FFD685C00F844102000068703340008D44244050FFD685C00F842D020000688C3340008D44244050FFD685C00F841902000068A43340008D44244050FFD685C00F840502000068BC3340008D44244050FFD685C00F84F101000068D43340008D44244050FFD685C00F84DD01000068E83340008D44244050FFD685C00F84C901000068043440008D44244050FFD685C00F84B501000068143440008D44244050FFD685C00F84A1010000682C3440008D44244050FFD685C00F848D010000683C3440008D44244050FFD685C00F847901000068583440008D44244050FFD685C00F8465010000F644241010FF75088D842464020000507436FF155C3040008D44243C508D84246402000050FFD368803440008D84246402000050FFD38D84246002000050E896FDFFFFE91C010000FF155C3040008D44243C508D84246402000050FFD38D44243C50E8F60500008BF8C704248434400057FFD685C00F84EA000000689034400057FFD685C00F84DA000000689C34400057FFD685C00F84CA00000068A834400057FFD685C00F84BA00000068B434400057FFD685C00F84AA00000068C034400057FFD685C00F849A00000068CC34400057FFD685C00F848A00000068D834400057FFD685C0747E68E434400057FFD685C0747268F034400057FFD685C0746668FC34400057FFD685C0745A680835400057FFD685C0744E681435400057FFD685C07442682035400057FFD685C07436683435400057FFD685C0742A684035400057FFD685C0741E688C3240008D44244050FFD685C0740E8D84246002000050E829000000598D44241050FF742410FF155430400085C00F85B8FCFFFFFF74240CFF15483040005F5E5B8BE55DC3558BEC81EC4802000053565768843F4000FF15083040008B35243040005033FF57FFD68B1D1030400050FFD368843F40008945E8FF15083040008945F4B8843F4000397DF474138B4DE82BC88A10FF4DF488140140397DF475F257576A03575768000000C0FF7508FF15343040008945F83BC70F845F0300008D4DDC5150FF15383040006A1057FFD650FFD36A10578945F4FFD650FFD3FF75F48945F0E8B2040000FF75F0E8AA0400005959680001000057FFD650FFD36800010000578945CCFFD650FFD3FF75CC8B55F48945C8E8990E0000FF75C88B55F0E88E0E00008B1D1430400059595757FF75E0FF75DCFF75F8FFD357FF1540304000578D45D0506800010000FF75CCFF75F8FF1528304000FF153C30400083F8060F84B9020000FF153C30400083F8130F84AA0200008B45DC8B4DE05705000100005713CF5150FF75F8FFD3578D45D0506800010000FF75C8FF75F8FF15283040008B45DC8B4DE05705000200005713CF5150FF75F8FFD3578D45D05068843F4000FF150830400050FF75E8FF75F8FF15283040008B45E08B4DDC3BC70F8C660100007F0C81F90090D0030F86E5000000897DD4897DD83BC70F8CBC0100007F0D3BCF0F86B2010000EB038B4DDC2B4DD41B45D88945E80F889E0100007F0C81F990D003000F82900100006848E8010057FFD650FF15103040005757FF75D88945E8FF75D4FF75F8FFD3578D45C4506848E80100FF75E8FF75F8FF1530304000FF75F08B55F4FF75F06848E80100FF75E8E8AFF8FFFF83C4105757FF75D8FF75D4FF75F8FFD3578D45D0506848E80100FF75E8FF75F8FF1528304000FFD6FF75E85750FF15183040008145D490D003008B45E0117DD83945D80F8C4CFFFFFF0F8FF60000008B4DDC394DD40F823DFFFFFFE9E50000003BC77C6F7F0881F9804F1200766568C027090057FFD650FF1510304000575733C98945E85133C050FF75F8FFD3578D45C45068C0270900FF75E8FF75F8FF1530304000FF75F08B55F4FF75F068C0270900FF75E8E8F6F7FFFF83C410575733C05050FF75F8FFD3578D45D05068C0270900EB595157FFD650FF1510304000575733C98945E85133C050FF75F8FFD3578D45C450FF75DCFF75E8FF75F8FF1530304000FF75F08B55F4FF75F0FF75DCFF75E8E899F7FFFF83C410575733C05050FF75F8FFD3578D45D050FF75DCFF75E8FF75F8FF1528304000FF75E857FFD650FF1518304000FF75F8FF1558304000FF75CC57FFD68B1D1830400050FFD3FF75C8

      */

      $bp = { 558B??83????53565789????29????6A??8D????8D????5A8B??89????8A????88????8B????8A????88??8A????88????8A??88????03??03??FF????75??89????8D????8D????8D????89????89????29????89????29????89????29????8D????8D????89????29????89????29????8B????89????29????8D????F6??????8B????8A????8B????8A????8A??88????8B????8A????88????75??0FB6??8A??????????0FB6??88????8A??????????0FB6????8A??????????88????0FB6????8A??????????88????8B????C1????32??????????8B????8A????32??8B????88????8A????32??88????8A??32????83????88????8B????8A????32????FF????88??83????83????83??????0F82????????5F5E5BC9C3558B??560FB6??57C1????03????6A??5F6A??5E8A??30??40414E75??4F75??5F5E5DC356576A??5F6A??8B??5E0FB6??8A??????????88??83????4E75??414F75??5F5EC38A????8A????88????8A????88????8A????88????8A????88????8A????88????8A????88????8A????88????8A????88????8A????88????8A????88????8A????88????88????C3558B??5153566A??83????5E8A????32??8A????8A????88????32??32??88????88????32??8A??C0????B3??F6??02??32??32????8A????32????32??88????8A??C0????F6??02??32??32????8A????32????88????8A??C0????F6??02??32??32??8A????32????32????88??8A??C0????F6??02??32??32????83????32????4E88????75??5E5BC9C3558B??53FF????8B??32??E8????????59B3??8B??E8????????8B??E8????????8B??E8????????FF????8B??8A??E8????????FE??5980????72??8B??E8????????8B??E8????????5B8B??B0??5DE9????????558B??81??????????53568D??????????E8????????33??6A??5939????76??5783????75??8B????8D????A5A5A58D??????????A5508D????E8????????596A??588B????8D????80????75??48C6????79??EB??FE????33??8A??????8B????30????43413B????72??5F8B????8B????6A??2B??5E8A????88??404E75??5E5BC9C3558B??81??????????53FF????8D??????????50FF??????????68????????8D??????????50FF??????????33??53536A??535368????????8D??????????50FF??????????89????3B??0F84????????56578D????5053BE????????5689????FF??????????5056E8????????83????85??75??53FF??????????FF????8B??????????53FF??50FF??????????8D????51505689????FF??????????5056E8????????83????85??74??8B????89????8D????50FF????E8????????59595385??74??8D????50FF????FF????FF????FF??????????FF????53FF??50FF??????????5F5E5BC9C3558B??83????81??????????535657FF????8D????????????50FF??????????8B??????????68????????8D????????????50FF??8D??????508D????????????50FF??????????89??????83????0F84????????8B??????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????68????????8D??????50FF??85??0F84????????F6????????FF????8D????????????5074??FF??????????8D??????508D????????????50FF??68????????8D????????????50FF??8D????????????50E8????????E9????????FF??????????8D??????508D????????????50FF??8D??????50E8????????8B??C7????????????57FF??85??0F84????????68????????57FF??85??0F84????????68????????57FF??85??0F84????????68????????57FF??85??0F84????????68????????57FF??85??0F84????????68????????57FF??85??0F84????????68????????57FF??85??0F84????????68????????57FF??85??74??68????????57FF??85??74??68????????57FF??85??74??68????????57FF??85??74??68????????57FF??85??74??68????????57FF??85??74??68????????57FF??85??74??68????????57FF??85??74??68????????57FF??85??74??68????????8D??????50FF??85??74??8D????????????50E8????????598D??????50FF??????FF??????????85??0F85????????FF??????FF??????????5F5E5B8B??5DC3558B??81??????????53565768????????FF??????????8B??????????5033??57FF??8B??????????50FF??68????????89????FF??????????89????B8????????39????74??8B????2B??8A??FF????88????4039????75??57576A??575768????????FF????FF??????????89????3B??0F84????????8D????5150FF??????????6A??57FF??50FF??6A??5789????FF??50FF??FF????89????E8????????FF????E8????????595968????????57FF??50FF??68????????5789????FF??50FF??FF????8B????89????E8????????FF????8B????E8????????8B??????????59595757FF????FF????FF????FF??57FF??????????578D????5068????????FF????FF????FF??????????FF??????????83????0F84????????FF??????????83????0F84????????8B????8B????5705????????5713??5150FF????FF??578D????5068????????FF????FF????FF??????????8B????8B????5705????????5713??5150FF????FF??578D????5068????????FF??????????50FF????FF????FF??????????8B????8B????3B??0F8C????????7F??81??????????0F86????????89????89????3B??0F8C????????7F??3B??0F86????????EB??8B????2B????1B????89????0F88????????7F??81??????????0F82????????68????????57FF??50FF??????????5757FF????89????FF????FF????FF??578D????5068????????FF????FF????FF??????????FF????8B????FF????68????????FF????E8????????83????5757FF????FF????FF????FF??578D????5068????????FF????FF????FF??????????FF??FF????5750FF??????????81????????????8B????11????39????0F8C????????0F8F????????8B????39????0F82????????E9????????3B??7C??7F??81??????????76??68????????57FF??50FF??????????575733??89????5133??50FF????FF??578D????5068????????FF????FF????FF??????????FF????8B????FF????68????????FF????E8????????83????575733??5050FF????FF??578D????5068????????EB??5157FF??50FF??????????575733??89????5133??50FF????FF??578D????50FF????FF????FF????FF??????????FF????8B????FF????FF????FF????E8????????83????575733??5050FF????FF??578D????50FF????FF????FF????FF??????????FF????57FF??50FF??????????FF????FF??????????FF????57FF??8B??????????50FF??FF???? }

      
   condition:

      uint16(0) == 0x5a4d and
      filesize < 200KB and
      all of ($s*) or
      all of ($op*) or 
      $bp
}

rule nefilim_signed {

    meta:

        author = "Marc Rivero | McAfee ATR Team"
        description = "Rule to detect Nefilim samples digitally signed"
        reference = "https://www.bleepingcomputer.com/news/security/new-nefilim-ransomware-threatens-to-release-victims-data/"
        date = "2020-04-02"
        hash = "353ee5805bc5c7a98fb5d522b15743055484dc47144535628d102a4098532cd5"
        
    condition:

      uint16(0) == 0x5a4d and
      for any i in (0 .. pe.number_of_signatures) : (
         pe.signatures[i].subject contains "Red GmbH/CN=Red GmbH"  and
         pe.signatures[i].serial == "00:b8:81:a7:2d:41:17:bb:c3:8b:81:d3:c6:5c:79:2c:1a" or
         pe.signatures[i].thumbprint == "5b:19:58:8b:78:74:0a:4c:5d:08:41:99:dc:0f:52:a6:1f:38:00:99")
}
